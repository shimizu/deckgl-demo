import{r as c}from"./react-ZEDBDnLt.js";import{V as S,L as E,D as I}from"./deckgl_core-C7kG8c7H.js";const M=typeof window<"u"?c.useLayoutEffect:c.useEffect;function R(e,n){for(;e;){if(e===n)return!0;e=Object.getPrototypeOf(e)}return!1}const U={position:"absolute",zIndex:-1};function j(e,n){if(typeof e=="function")return e(n);if(Array.isArray(e))return e.map(r=>j(r,n));if(m(e)){if(D(e))return n.style=U,c.cloneElement(e,n);if(A(e))return c.cloneElement(e,n)}return e}function m(e){return e&&typeof e=="object"&&"type"in e||!1}function D(e){var n;return(n=e.props)==null?void 0:n.mapStyle}function A(e){const n=e.type;return n&&n.deckGLViewProps}function C(e){if(typeof e=="function")return c.createElement(S,{},e);if(Array.isArray(e))return e.map(C);if(m(e)){if(e.type===c.Fragment)return C(e.props.children);if(R(e.type,S))return e}return e}function _({children:e,layers:n=[],views:r=null}){const s=[],o=[],t={};return c.Children.forEach(C(e),i=>{if(m(i)){const a=i.type;if(R(a,E)){const f=q(a,i.props);o.push(f)}else s.push(i);if(R(a,S)&&a!==S&&i.props.id){const f=new a(i.props);t[f.id]=f}}else i&&s.push(i)}),Object.keys(t).length>0&&(Array.isArray(r)?r.forEach(i=>{t[i.id]=i}):r&&(t[r.id]=r),r=Object.values(t)),n=o.length>0?[...o,...n]:n,{layers:n,children:s,views:r}}function q(e,n){const r={},s=e.defaultProps||{};for(const o in n)s[o]!==n[o]&&(r[o]=n[o]);return new e(r)}function P({children:e,deck:n,ContextProvider:r}){const{viewManager:s}=n||{};if(!s||!s.views.length)return[];const o={},t=s.views[0].id;for(const i of e){let a=t,f=i;m(i)&&R(i.type,S)&&(a=i.props.id||t,f=i.props.children);const d=s.getViewport(a),w=s.getViewState(a);if(d){w.padding=d.padding;const{x:y,y:v,width:k,height:p}=d;f=j(f,{x:y,y:v,width:k,height:p,viewport:d,viewState:w}),o[a]||(o[a]={viewport:d,children:[]}),o[a].children.push(f)}}return Object.keys(o).map(i=>{const{viewport:a,children:f}=o[i],{x:d,y:w,width:y,height:v}=a,k={position:"absolute",left:d,top:w,width:y,height:v},p=`view-${i}`,h=c.createElement("div",{key:p,id:p,style:k},...f);if(r){const V={viewport:a,container:n.canvas.offsetParent,eventManager:n.eventManager,onViewStateChange:g=>{g.viewId=i,n._onViewStateChange(g)}};return c.createElement(r,{key:p,value:V},h)}return h})}const z={mixBlendMode:null};function G({width:e,height:n,style:r}){const s={position:"absolute",zIndex:0,left:0,top:0,width:e,height:n},o={left:0,top:0};if(r)for(const t in r)t in z?o[t]=r[t]:s[t]=r[t];return{containerStyle:s,canvasStyle:o}}function Y(e){return{get deck(){return e.deck},pickObject:n=>e.deck.pickObject(n),pickMultipleObjects:n=>e.deck.pickMultipleObjects(n),pickObjects:n=>e.deck.pickObjects(n)}}function L(e){e.redrawReason&&(e.deck._drawLayers(e.redrawReason),e.redrawReason=null)}function F(e,n,r){const s=new n({...r,_customRender:o=>{e.redrawReason=o;const t=s.getViewports();e.lastRenderedViewports!==t?e.forceUpdate():L(e)}});return s}function H(e,n){const[r,s]=c.useState(0),t=c.useRef({control:null,version:r,forceUpdate:()=>s(u=>u+1)}).current,i=c.useRef(null),a=c.useRef(null),f=c.useMemo(()=>_(e),[e.layers,e.views,e.children]);let d=!0;const w=u=>{var l;return d&&e.viewState?(t.viewStateUpdateRequested=u,null):(t.viewStateUpdateRequested=null,(l=e.onViewStateChange)==null?void 0:l.call(e,u))},y=u=>{var l;d?t.interactionStateUpdateRequested=u:(t.interactionStateUpdateRequested=null,(l=e.onInteractionStateChange)==null||l.call(e,u))},v=c.useMemo(()=>{const u={...e,style:null,width:"100%",height:"100%",parent:i.current,canvas:a.current,layers:f.layers,views:f.views,onViewStateChange:w,onInteractionStateChange:y};return delete u._customRender,t.deck&&t.deck.setProps(u),u},[e]);c.useEffect(()=>{const u=e.Deck||I;return t.deck=F(t,u,{...v,parent:i.current,canvas:a.current}),()=>{var l;return(l=t.deck)==null?void 0:l.finalize()}},[]),M(()=>{L(t);const{viewStateUpdateRequested:u,interactionStateUpdateRequested:l}=t;u&&w(u),l&&y(l)}),c.useImperativeHandle(n,()=>Y(t),[]);const k=t.deck&&t.deck.isInitialized?t.deck.getViewports():void 0,{ContextProvider:p,width:h="100%",height:V="100%",id:g,style:b}=e,{containerStyle:x,canvasStyle:O}=c.useMemo(()=>G({width:h,height:V,style:b}),[h,V,b]);if(!t.viewStateUpdateRequested&&t.lastRenderedViewports===k||t.version!==r){t.lastRenderedViewports=k,t.version=r;const u=P({children:f.children,deck:t.deck,ContextProvider:p}),l=c.createElement("canvas",{key:"canvas",id:g||"deckgl-overlay",ref:a,style:O});t.control=c.createElement("div",{id:`${g||"deckgl"}-wrapper`,ref:i,style:x},[l,u])}return d=!1,t.control}const B=c.forwardRef(H);export{B as D};
